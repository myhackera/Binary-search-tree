import sys
mx = sys.maxsize
mn = -mx

class Solution: 
    def maxSumBST(self, root: Optional[TreeNode]) -> int:
        
        def dfs(root):
            
            nonlocal res
            if root is None:
                return True, 0, mx, mn
            
            lres, lsum, lmin, lmax = dfs(root.left)
            rres, rsum, rmin, rmax = dfs(root.right)
            
            if lres and rres and lmax < root.val < rmin:
                
                res = max(res, lsum + rsum + root.val)
                return True, lsum+rsum+root.val, min(root.val, lmin), max(root.val, rmax)
            else:
                return False, 0, 0, 0
            
            
        
        
        res = 0
        dfs(root)
        return res
